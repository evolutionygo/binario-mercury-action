name: Build YGO Mobile with Docker

on:
  push:
    branches:
      - server
  pull_request:
    branches:
      - server

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Principal Repository (YGOMobile-cn-ko-en)
        uses: actions/checkout@v3
        with:
          repository: fallenstardust/YGOMobile-cn-ko-en
          ref: server
          path: base-repo

      - name: Define List of Files to Replace
        run: |
          echo "FILES=('ocgcore/ocgcore.cpp' 'ocgcore/ocgcore.h' 'lua/lua_core.cpp')" >> $GITHUB_ENV

      - name: Checkout Secondary Repository (ygopro-evolution-bin)
        run: |
          git clone --branch=server --depth=1 https://github.com/termitaklk/ygopro-evolution-bin merge-repo

      - name: Copy and Replace Selected Files
        run: |
          for file in ${FILES[@]}; do
            if [ -f "merge-repo/$file" ]; then
              cp -f "merge-repo/$file" "base-repo/$file"
              echo "Replaced: $file"
            else
              echo "File not found in secondary repo: $file"
            fi
          done

      - name: Continue with Build Process
        run: |
          cd base-repo
          chmod +x scripts/build_ygopro.sh
          ./scripts/build_ygopro.sh

      - name: Validate Binary Existence
        run: |
          if [ ! -f base-repo/build/ygopro ]; then
            echo "Binary not found!"
            exit 1
          fi

      - name: Upload YGOPRO Binary as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ygopro-binary
          path: base-repo/build/ygopro


















