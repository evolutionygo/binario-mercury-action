name: Build YGO Mobile with Docker

on:
  push:
    branches:
      - main  # ‚úÖ El workflow SE EJECUTA desde la rama main del repo del Action
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ Clonamos el repositorio PRINCIPAL en la rama SERVER
      - name: Checkout Principal Repository (YGOPRO - MyCard)
        uses: actions/checkout@v3
        with:
          repository: mycard/ygopro
          ref: server  # ‚úÖ Siempre usamos la rama server
          path: base-repo

      - name: Debug - List Directory Contents
        run: |
          echo "üìÇ Listado de archivos en base-repo/"
          ls -l base-repo
          echo "üìÇ Listado de archivos en base-repo/scripts/"
          ls -l base-repo/scripts || echo "‚ö†Ô∏è El directorio scripts/ no existe"

      - name: Define List of Files to Replace
        run: |
          echo "Definiendo archivos a reemplazar..."
          echo "FILES=ocgcore/ocgcore.cpp ocgcore/ocgcore.h lua/lua_core.cpp" >> $GITHUB_ENV
          echo "‚úÖ Archivos definidos: ocgcore/ocgcore.cpp, ocgcore/ocgcore.h, lua/lua_core.cpp"

      # ‚úÖ Clonamos el repositorio SECUNDARIO en la rama SERVER
      - name: Checkout Secondary Repository (ygopro-evolution-bin)
        run: |
          echo "üîÑ Clonando el repositorio secundario..."
          git clone --branch=server --depth=1 https://github.com/termitaklk/ygopro-evolution-bin merge-repo
          echo "‚úÖ Repositorio secundario clonado en merge-repo/"
          ls -l merge-repo

      - name: Copy and Replace Selected Files
        run: |
          echo "üîÑ Iniciando reemplazo de archivos..."
          for file in $FILES; do
            if [ -f "merge-repo/$file" ]; then
              cp -f "merge-repo/$file" "base-repo/$file"
              echo "‚úÖ Reemplazado: $file"
            else
              echo "‚ö†Ô∏è Archivo no encontrado en el repositorio secundario: $file"
            fi
          done

      - name: Debug - Post Merge File Structure
        run: |
          echo "üìÇ Estructura de archivos despu√©s de la fusi√≥n:"
          ls -lR base-repo

      - name: Continue with Build Process
        run: |
          echo "üîÑ Iniciando compilaci√≥n..."
          if [ ! -f base-repo/scripts/build_ygopro.sh ]; then
            echo "‚ùå ERROR: El script de compilaci√≥n no existe en base-repo/scripts/"
            exit 1
          fi
          cd base-repo
          chmod +x scripts/build_ygopro.sh
          ./scripts/build_ygopro.sh
          echo "‚úÖ Compilaci√≥n finalizada."

      - name: Validate Binary Existence
        run: |
          echo "üîç Verificando existencia del binario compilado..."
          if [ ! -f base-repo/build/ygopro ]; then
            echo "‚ùå Binary not found! Error en la compilaci√≥n."
            exit 1
          fi
          echo "‚úÖ Binario encontrado: base-repo/build/ygopro"

      - name: Upload YGOPRO Binary as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ygopro-binary
          path: base-repo/build/ygopro

      - name: Log - Build Completed
        run: echo "üéâ Proceso completado exitosamente. Binario generado y almacenado como artefacto."




















