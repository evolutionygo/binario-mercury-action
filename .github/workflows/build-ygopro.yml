name: Build YGO Mobile with Docker

on:
  push:
    branches:
      - main  # ‚úÖ El workflow se ejecuta en la rama main del repositorio del Action
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository of the Action
        uses: actions/checkout@v3
        with:
          path: action-repo  # ‚úÖ El Action se ejecuta aqu√≠ (donde est√° el script de compilaci√≥n)

      - name: Debug - Verificar scripts en el Action
        run: |
          echo "üìÇ Listado de archivos en el repo del Action:"
          ls -l action-repo
          echo "üìÇ Listado de archivos en action-repo/scripts/"
          ls -l action-repo/scripts || echo "‚ö†Ô∏è El directorio scripts/ no existe en el Action"

      # ‚úÖ Clonamos el REPO PRINCIPAL (YGOPRO) en la rama SERVER
      - name: Checkout Principal Repository (YGOPRO - MyCard)
        uses: actions/checkout@v3
        with:
          repository: mycard/ygopro
          ref: server  # ‚úÖ Siempre usamos la rama server
          path: base-repo

      # ‚úÖ Clonamos el REPO SECUNDARIO (ygopro-evolution-bin) en la rama SERVER
      - name: Checkout Secondary Repository (ygopro-evolution-bin)
        run: |
          echo "üîÑ Clonando el repositorio secundario..."
          git clone --branch=server --depth=1 https://github.com/termitaklk/ygopro-evolution-bin merge-repo
          echo "‚úÖ Repositorio secundario clonado en merge-repo/"
          ls -l merge-repo

      - name: Define List of Files to Replace
        run: |
          echo "Definiendo archivos a reemplazar..."
          echo "FILES=gframe/deck_manager.cpp gframe/deck_manager.h gframe/data_manager.cpp" >> $GITHUB_ENV
          echo "‚úÖ Archivos definidos: gframe/deck_manager.cpp, gframe/deck_manager.h, gframe/data_manager.cpp"

      - name: Copy and Replace Selected Files
        run: |
          echo "üîÑ Iniciando reemplazo de archivos..."
          for file in $FILES; do
            if [ -f "merge-repo/$file" ]; then
              cp -f "merge-repo/$file" "base-repo/$file"
              echo "‚úÖ Reemplazado: $file"
            else
              echo "‚ö†Ô∏è Archivo no encontrado en el repositorio secundario: $file"
            fi
          done

      - name: Debug - Post Merge File Structure
        run: |
          echo "üìÇ Estructura de archivos despu√©s de la fusi√≥n:"
          ls -lR base-repo/gframe

      - name: Continue with Build Process (Using Action's Script)
        run: |
          echo "üîÑ Iniciando compilaci√≥n con el script del Action..."
          if [ ! -f action-repo/scripts/build_ygopro.sh ]; then
            echo "‚ùå ERROR: El script de compilaci√≥n NO EXISTE en action-repo/scripts/"
            exit 1
          fi
          chmod +x action-repo/scripts/build_ygopro.sh
          set -x  # üîç Muestra todos los comandos ejecutados
          action-repo/scripts/build_ygopro.sh
          set +x
          echo "‚úÖ Compilaci√≥n finalizada."

      - name: Debug - Buscar binario en todo el repositorio
        run: |
          echo "üîé Buscando el binario generado en base-repo..."
          find base-repo -type f -name "ygopro"

      - name: Validate Binary Existence
        run: |
          echo "üîç Verificando existencia del binario compilado..."
          BINARY_PATH=$(find base-repo -type f -name "ygopro" | head -n 1)
          if [ -z "$BINARY_PATH" ]; then
            echo "‚ùå Binary not found! Error en la compilaci√≥n."
            exit 1
          fi
          echo "‚úÖ Binario encontrado en: $BINARY_PATH"

      - name: Upload YGOPRO Binary as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ygopro-binary
          path: base-repo/build/ygopro

      - name: Log - Build Completed
        run: echo "üéâ Proceso completado exitosamente. Binario generado y almacenado como artefacto."





















