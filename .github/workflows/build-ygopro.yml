name: Build YGO Mobile with Docker

on:
  push:
    branches:
      - server
  pull_request:
    branches:
      - server

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Principal Repository (YGOMobile-cn-ko-en)
        uses: actions/checkout@v3
        with:
          repository: fallenstardust/YGOMobile-cn-ko-en
          ref: server
          path: base-repo

      - name: Log - Principal Repository Cloned
        run: |
          echo "‚úÖ Repositorio principal clonado en base-repo/"
          ls -l base-repo

      - name: Define List of Files to Replace
        run: |
          echo "Definiendo archivos a reemplazar..."
          echo "FILES=('ocgcore/ocgcore.cpp' 'ocgcore/ocgcore.h' 'lua/lua_core.cpp')" >> $GITHUB_ENV
          echo "‚úÖ Archivos definidos: ocgcore/ocgcore.cpp, ocgcore/ocgcore.h, lua/lua_core.cpp"

      - name: Checkout Secondary Repository (ygopro-evolution-bin)
        run: |
          echo "üîÑ Clonando el repositorio secundario..."
          git clone --branch=server --depth=1 https://github.com/termitaklk/ygopro-evolution-bin merge-repo
          echo "‚úÖ Repositorio secundario clonado en merge-repo/"
          ls -l merge-repo

      - name: Copy and Replace Selected Files
        run: |
          echo "üîÑ Iniciando reemplazo de archivos..."
          for file in ${FILES[@]}; do
            if [ -f "merge-repo/$file" ]; then
              cp -f "merge-repo/$file" "base-repo/$file"
              echo "‚úÖ Reemplazado: $file"
            else
              echo "‚ö†Ô∏è Archivo no encontrado en el repositorio secundario: $file"
            fi
          done

      - name: Log - Post Merge File Structure
        run: |
          echo "üìÇ Estructura de archivos despu√©s de la fusi√≥n:"
          ls -lR base-repo

      - name: Continue with Build Process
        run: |
          echo "üîÑ Iniciando compilaci√≥n..."
          cd base-repo
          chmod +x scripts/build_ygopro.sh
          ./scripts/build_ygopro.sh
          echo "‚úÖ Compilaci√≥n finalizada."

      - name: Validate Binary Existence
        run: |
          echo "üîç Verificando existencia del binario compilado..."
          if [ ! -f base-repo/build/ygopro ]; then
            echo "‚ùå Binary not found! Error en la compilaci√≥n."
            exit 1
          fi
          echo "‚úÖ Binario encontrado: base-repo/build/ygopro"

      - name: Upload YGOPRO Binary as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ygopro-binary
          path: base-repo/build/ygopro

      - name: Log - Build Completed
        run: echo "üéâ Proceso completado exitosamente. Binario generado y almacenado como artefacto."



















